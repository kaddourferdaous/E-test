<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<!-- Bootstrap JS (for interactive components like tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Écran de chargement -->
<div class="loading-screen d-flex justify-content-center align-items-center" *ngIf="loading">
  <div class="card loading-card shadow-sm">
    <div class="card-body text-center">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Chargement du profil...</p>
    </div>
  </div>
</div>

<!-- Écran d'erreur -->
<div class="error-screen d-flex justify-content-center align-items-center" *ngIf="error && !loading">
  <div class="card error-card shadow-sm">
    <div class="card-body text-center">
      <i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>
      <h2 class="card-title mt-3">Erreur de chargement</h2>
      <p>{{ error }}</p>
      <button class="btn btn-primary retry-btn" (click)="retryFetch()">Réessayer</button>
    </div>
  </div>
</div>

<!-- Contenu principal -->
<div class="profile-container" *ngIf="!loading && !error">
  <div class="container py-4">
    <!-- En-tête du profil -->
    <div class="profile-header card shadow-sm mb-4">
      <div class="card-body">
 <div class="row align-items-center">
  <div class="col-md-3 text-center">
    <div class="avatar-section">
      <div class="avatar rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center" *ngIf="!candidateInfo?.avatar">
        {{ getInitials() }}
      </div>
      <img
        *ngIf="candidateInfo?.avatar"
        [src]="candidateInfo?.avatar"
        alt="Avatar"
        class="avatar-img rounded-circle img-fluid"
      />
      <span class="badge {{ getStatusBadgeClass() }} mt-2">
        <i class="fa fa-check-circle me-1"></i>{{ getStatusText() }}
      </span>
    </div>
  </div>
  <div class="col-md-9">
    <div class="user-details">
      <h1 class="user-name h3">
        <i class="fa fa-user me-2"></i>{{ getCandidateName() }}
      </h1>
      <p class="user-email text-muted">
        <i class="fa fa-envelope me-2"></i>{{ getCandidateEmail() }}
      </p>
      <p class="user-matricule text-muted">
        <i class="fa fa-id-card me-2"></i>Matricule: {{ getCandidateMatricule() }}
      </p>
      <div class="row stats-grid">
        <div class="col-6 col-sm-4 mb-3">
          <div class="card stat-card stat-blue shadow-sm text-center">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-center">
                <i class="fa fa-star fa-3x text-warning me-3"></i>
                <div>
                  <div class="stat-value">{{ getFinalTestScore() }}</div>
                  <div class="stat-label">Note test final</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6 col-sm-4 mb-3">
          <div class="card stat-card {{ getStatusBadgeClass() }} shadow-sm text-center">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-center">
                <i class="fa fa-info-circle fa-3x text-white me-3"></i>
                <div>
                  <div class="stat-value">{{ getStatusText() }}</div>
                  <div class="stat-label" style="color:white;">Statut</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6 col-sm-4 mb-3">
          <div class="card stat-card stat-purple shadow-sm text-center">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-center">
                <i class="fa fa-clock fa-3x text-light me-3"></i>
                <div>
                  <div class="stat-value">{{ getFinalTestDuration() }}</div>
                  <div class="stat-label">Temps test final</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      </div>
    </div>

    <!-- Navigation par onglets -->
    <div class="tabs-container card shadow-sm">
      <div class="card-header">
        <ul class="nav nav-tabs tabs-nav">
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'overview'" (click)="selectTab('overview')">
              <i class="bi bi-person"></i> Vue d'ensemble
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'progress'" (click)="selectTab('progress')">
              <i class="bi bi-graph-up"></i> Progression
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'achievements'" (click)="selectTab('achievements')">
              <i class="bi bi-trophy"></i> Récompenses
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'profile'" (click)="selectTab('profile')">
              <i class="bi bi-gear"></i> Profil
            </button>
          </li>
        </ul>
      </div>

      <!-- Contenu des onglets -->
      <div class="tab-content card-body">
        <!-- Onglet Vue d'ensemble -->
        <div class="tab-panel" *ngIf="selectedTab === 'overview'">
          <!-- Progression globale -->
          <div class="progress-card card shadow-sm mb-4">
            <div class="card-body">
              <h3 class="card-title">Progression des modules</h3>
              <div class="progress-info d-flex justify-content-between">
                <span>{{ progressData?.completedModules || 0 }} sur {{ progressData?.totalModules || 0 }} modules complétés</span>
                <span>{{ getCompletionPercentage() }}%</span>
              </div>
              <div class="progress-bar-container">
                <div
                  class="progress-bar"
                  [style.width]="getProgressBarWidth(getCompletionPercentage())"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Progression -->
        <div class="tab-panel" *ngIf="selectedTab === 'progress'">
          <!-- Progression hebdomadaire -->
          <div class="weekly-progress">
            <h3 class="section-title">Progression hebdomadaire</h3>
            <div class="week-list">
              <div
                class="week-item card shadow-sm mb-2"
                *ngFor="let week of progressData?.weeklyProgress"
              >
                <div class="card-body">
                  <div class="week-header d-flex justify-content-between">
                    <span class="week-name">{{ week.week }}</span>
                    <span class="week-time">{{ formatTime(week.time) }}</span>
                  </div>
                  <div class="week-progress-bar">
                    <div
                      class="week-progress-fill"
                      [style.width]="getProgressBarWidth(week.completion)"
                    ></div>
                  </div>
                  <div class="week-percentage">{{ week.completion }}% complété</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Statistiques de temps -->
          <div class="time-stats row">
            <div class="col-md-4 mb-3">
              <div class="time-card time-total card shadow-sm text-center">
                <div class="card-body">
                  <i class="bi bi-clock time-icon fs-2"></i>
                  <h3 class="card-title">Temps d'étude total</h3>
                  <p class="time-value">{{ formatTime(progressData?.totalTimeSpent || 0) }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="time-card time-streak card shadow-sm text-center">
                <div class="card-body">
                  <i class="bi bi-calendar-check time-icon fs-2"></i>
                  <h3 class="card-title">Meilleure série</h3>
                  <p class="time-value">{{ progressData?.bestStreak || 0 }} jours</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="time-card time-best-score card shadow-sm text-center">
                <div class="card-body">
                  <i class="bi bi-star-fill time-icon fs-2"></i>
                  <h3 class="card-title">Meilleur score</h3>
                  <p class="time-value">{{ getBestScore() }}%</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Récompenses -->
        <div class="tab-panel" *ngIf="selectedTab === 'achievements'">
          <h3 class="section-title">Récompenses et badges</h3>
          <div *ngIf="!progressData?.achievements?.length" class="alert alert-info">
            Aucune récompense disponible.
          </div>
          <div class="achievements-grid row" *ngIf="progressData?.achievements?.length">
            <div
              class="col-md-4 mb-3"
              *ngFor="let achievement of progressData?.achievements"
            >
              <div class="achievement-card card shadow-sm" [class.earned]="achievement.earned">
                <div class="card-body d-flex align-items-center">
                  <div class="achievement-icon me-3">
                    <i class="bi bi-trophy-fill fs-2"></i>
                  </div>
                  <div class="achievement-content">
                    <h4 class="achievement-name card-title">{{ achievement.name }}</h4>
                    <p class="achievement-description card-text">{{ achievement.description }}</p>
                    <p
                      class="achievement-date text-muted"
                      *ngIf="achievement.earned && achievement.date"
                    >
                      Obtenu le {{ getFormattedDate(achievement.date) }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Profil -->
        <div class="tab-panel" *ngIf="selectedTab === 'profile'">
          <h3 class="section-title">Informations personnelles</h3>
          <div class="profile-details row">
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Nom complet</h4>
                  <p class="card-text">{{ getCandidateName() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Email</h4>
                  <p class="card-text">{{ getCandidateEmail() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Matricule</h4>
                  <p class="card-text">{{ getCandidateMatricule() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Téléphone</h4>
                  <p class="card-text">{{ getCandidateTelephone() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Adresse</h4>
                  <p class="card-text">{{ getCandidateAdresse() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Date de naissance</h4>
                  <p class="card-text">{{ getCandidateDateNaissance() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Niveau d'études</h4>
                  <p class="card-text">{{ getCandidateNiveau() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Ville d'origine</h4>
                  <p class="card-text">{{ getVilleOrigine() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Date de signature de contrat</h4>
                  <p class="card-text">{{ getContractSignedDate() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Date d'inscription</h4>
                  <p class="card-text">{{ getJoinDate() }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="detail-card card shadow-sm">
                <div class="card-body">
                  <h4 class="card-title">Dernière activité</h4>
                  <p class="card-text">{{ getLastActivity() }}</p>
                </div>
              </div>
            </div>
          </div>
          <div class="profile-status" *ngIf="!hasCompleteProfile()">
            <p class="warning-text">Votre profil est incomplet. Veuillez compléter vos informations personnelles.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>