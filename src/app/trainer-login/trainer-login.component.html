<!-- Page de connexion initiale -->
<div *ngIf="showLogin" class="login-container">
  <div class="card">
   
       <div class="logo-wrapper" style="margin-bottom: 10px;">
            <img 
              src="https://iconape.com/wp-content/png_logo_vector/yazaki-group-logo.png" 
              alt="Yazaki Logo"
              style="max-width: 160px; display: block; margin: 0 auto;"
            />
          </div>
   
    <div class="card-body">
      <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="matricule">Matricule :</label>
          <input 
            type="text" 
            id="matricule"
            class="form-control"
            formControlName="matricule"
            placeholder="Enter your matricule"
            autocomplete="username">
          <div *ngIf="loginForm.get('matricule')?.touched && loginForm.get('matricule')?.errors" class="text-danger">
            <small *ngIf="loginForm.get('matricule')?.errors?.['required']">Matricule is Required</small>
          </div>
        </div>

        <button 
          type="submit" 
          class="btn btn-primary btn-block"
          [disabled]="isLoading || loginForm.invalid">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
          Sign In
        </button>
      </form>
        <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

      <!-- Messages d'erreur -->
     
    </div>
  </div>
</div>

<!-- Section 2FA avec QR Code (affichée après authentification réussie) -->
<div *ngIf="showTwoFA" class="two-fa-section">
  <div class="card">
    <div class="card-header">
      <h3></h3>
      <button 
        type="button" 
        class="btn btn-outline-light btn-sm back-btn"
        (click)="backToLogin()">
        ← Login Back
      </button>
    </div>
    <div class="card-body">
      
      <!-- QR Code Display -->
      <div *ngIf="qrCodeUrl" class="qr-code-section text-center mb-4">
        <h5>Scanne the QR Code </h5>
        <img [src]="qrCodeUrl" alt="QR Code 2FA" class="qr-code-image">
        <p class="text-muted mt-2">
          <small>Use Google Authenticator Application or Any Other application TOTP</small>
        </p>
      </div>

      <!-- Informations utilisateur -->
      <div *ngIf="trainerData" class="user-info mb-3">
        <p><strong>Matricule :</strong> {{ trainerData.matricule }}</p>
        <p><strong>mail :</strong> {{ trainerData.email }}</p>
      </div>

      <!-- 2FA Form -->
      <form [formGroup]="twoFAForm" (ngSubmit)="onTwoFASubmit()">
        <div class="form-group">
          <label for="totpCode">authentification Code</label>
          <input 
            type="text" 
            id="totpCode"
            class="form-control totp-input"
            formControlName="totpCode"
            placeholder="Enter 6 Digit Code"
            maxlength="6"
            autocomplete="off">
          <div *ngIf="twoFAForm.get('totpCode')?.touched && twoFAForm.get('totpCode')?.errors" class="text-danger">
            <small *ngIf="twoFAForm.get('totpCode')?.errors?.['required']">Code Is Required</small>
            <small *ngIf="twoFAForm.get('totpCode')?.errors?.['pattern']">The Code Must Contain 6 Numbers</small>
          </div>
        </div>

        <button 
          type="submit" 
          class="btn btn-primary btn-block"
          [disabled]="isLoading || twoFAForm.invalid">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
          Verify The Code
        </button>
      </form>

  

      <!-- Messages d'erreur -->
      <div *ngIf="errorMessage" class="alert alert-danger mt-3">
        {{ errorMessage }}
      </div>
    </div>
  </div>
</div>

<!-- Section configuration 2FA -->
<div *ngIf="show2FASetup" class="setup-section">
  <div class="card">
    <div class="card-header">
      <h3> 2FA Configuration</h3>
      <button 
        type="button" 
        class="btn btn-outline-light btn-sm back-btn"
        (click)="cancelSetup()">
        ← Back
      </button>
    </div>
    <div class="card-body">
      
      <!-- QR Code pour setup -->
      <div *ngIf="qrCodeUrl" class="qr-code-section text-center mb-4">
        <h5>Scanne The QR code To configure Your 2FA :</h5>
        <img [src]="qrCodeUrl" alt="QR Code Configuration 2FA" class="qr-code-image">
      
      </div>

      <!-- Form de vérification setup -->
      <form [formGroup]="twoFAForm" (ngSubmit)="verify2FASetup()">
        <div class="form-group">
          <label for="setupTotpCode">Verification Code</label>
          <input 
            type="text" 
            id="setupTotpCode"
            class="form-control totp-input"
            formControlName="totpCode"
            placeholder="Entrez le code à 6 chiffres"
            maxlength="6"
            autocomplete="off">
        </div>

      
      </form>

      <!-- Messages d'erreur -->
      <div *ngIf="errorMessage" class="alert alert-danger mt-3">
        {{ errorMessage }}
      </div>
    </div>
  </div>
</div>

<!-- Section codes de récupération -->
<div *ngIf="showBackupCodes" class="backup-codes-section">
  <div class="card">
    <div class="card-header">
      <h3>Codes de récupération 2FA</h3>
    </div>
    <div class="card-body">
      <div class="alert alert-warning">
        <strong>Important :</strong> Conservez ces codes en lieu sûr. Chaque code ne peut être utilisé qu'une seule fois.
      </div>

      <div class="backup-codes">
        <div *ngFor="let code of backupCodes; let i = index" class="backup-code">
          {{ i + 1 }}. {{ code }}
        </div>
      </div>

      <div class="mt-3">
        <button 
          type="button" 
          class="btn btn-outline-primary btn-sm mr-2"
          (click)="printBackupCodes()">
          Imprimer
        </button>
        
        <button 
          type="button" 
          class="btn btn-outline-success btn-sm mr-2"
          (click)="downloadBackupCodes()">
          Télécharger
        </button>
        
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="finishSetup()">
          Terminer la configuration
        </button>
      </div>
    </div>
  </div>
</div>